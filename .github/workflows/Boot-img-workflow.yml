name: Kernel Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      KERNEL_REPO: BlissRoms-Devices/android_kernel_asus_sm8250
      CLANG_REPO: SA9990/proton-clang
      KERNEL_DIR: android_kernel_asus_sm8250
      CLANG_DIR: proton-clang
      DEFCONFIG: vendor/obiwan_defconfig
      ARCH: arm64

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v3
        with:
          repository: ${{ env.KERNEL_REPO }}
          path: ${{ env.KERNEL_DIR }}
          fetch-depth: 1

      - name: Checkout Proton Clang
        uses: actions/checkout@v3
        with:
          repository: ${{ env.CLANG_REPO }}
          path: ${{ env.CLANG_DIR }}
          fetch-depth: 1

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex libssl-dev make clang lld

      - name: List Proton Clang Binaries
        run: ls -l ${{ env.CLANG_DIR }}/bin

      - name: Build Kernel
        working-directory: ${{ env.KERNEL_DIR }}
        run: |
          # Set up environment for Proton Clang
          export PATH="${{ env.CLANG_DIR }}/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export CLANG_TRIPLE=aarch64-linux-gnu-
          
          # Set the CROSS_COMPILE variable to use Clang exclusively
          export CROSS_COMPILE="${{ env.CLANG_DIR }}/bin/aarch64-linux-gnu-"
          export CROSS_COMPILE_ARM32="${{ env.CLANG_DIR }}/bin/arm-linux-gnueabi-"

          # Configure the kernel using Proton Clang
          make O=out ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE vendor/obiwan_defconfig 2>&1 | tee build.log

          # Build the kernel
          make -j$(nproc) O=out ARCH=$ARCH \
          CC=$CC \
          LD=$LD \
          CLANG_TRIPLE=$CLANG_TRIPLE \
          CROSS_COMPILE=$CROSS_COMPILE 2>&1 | tee -a build.log

      - name: Upload Kernel Build Artifacts
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: Kernel
          path: ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz-dtb

      - name: Upload Build Log
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: Build Log
          path: ${{ env.KERNEL_DIR }}/build.log
